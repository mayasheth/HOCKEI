---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Rival Watch - Select Rivals" activePage="rivals">
  <div class="max-w-2xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold" style="color: var(--text-primary);">Select Rivals</h1>
        <p class="text-sm mt-1" style="color: var(--text-secondary);">
          <span id="count">0</span> teams selected
        </p>
      </div>
      <button
        id="clear-btn"
        class="btn px-3 py-1.5 text-sm font-medium rounded-lg"
        style="background-color: rgba(255,255,255,0.1); color: var(--text-secondary);"
      >
        Clear all
      </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="flex flex-col items-center justify-center py-20">
      <div class="spinner w-8 h-8 border-2 border-white/20 border-t-white/80 rounded-full mb-4"></div>
      <p style="color: var(--text-secondary);">Loading teams...</p>
    </div>

    <!-- Team List -->
    <div id="team-list" class="hidden space-y-1"></div>
  </div>
</Layout>

<script>
  import { fetchTeams } from '../lib/nhl.js';
  import { getSelectedRivals, toggleRival, clearAllRivals } from '../lib/store.js';
  import { getTeamColors, accentRed } from '../lib/teamColors.js';

  const loading = document.getElementById('loading');
  const teamList = document.getElementById('team-list');
  const clearBtn = document.getElementById('clear-btn');
  const countEl = document.getElementById('count');

  let selectedRivals = getSelectedRivals();

  function updateCount() {
    if (countEl) {
      countEl.textContent = selectedRivals.size.toString();
    }
  }

  function createTeamRow(team) {
    const isSelected = selectedRivals.has(team.abbreviation);
    const colors = getTeamColors(team.abbreviation);

    return `
      <button
        class="team-row w-full flex items-center gap-4 p-3 rounded-lg text-left"
        data-abbrev="${team.abbreviation}"
        style="background-color: ${isSelected ? 'rgba(205, 92, 92, 0.15)' : 'transparent'};"
      >
        <img
          src="/logos/${team.abbreviation.toLowerCase()}.png"
          alt="${team.name}"
          class="w-10 h-10 object-contain"
        />
        <div class="flex-1 min-w-0">
          <p class="font-medium truncate" style="color: var(--text-primary);">
            ${team.name}
          </p>
          <p class="text-sm" style="color: var(--text-muted);">
            ${team.abbreviation}
          </p>
        </div>
        <div
          class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all"
          style="border-color: ${isSelected ? accentRed : 'rgba(255,255,255,0.3)'}; background-color: ${isSelected ? accentRed : 'transparent'};"
        >
          ${isSelected ? `
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          ` : ''}
        </div>
      </button>
    `;
  }

  function renderTeams(teams) {
    if (!teamList) return;
    teamList.innerHTML = teams.map(createTeamRow).join('');
    updateCount();
  }

  function handleTeamClick(e) {
    const btn = e.target.closest('.team-row');
    if (!btn) return;

    const abbrev = btn.dataset.abbrev;
    if (!abbrev) return;

    selectedRivals = toggleRival(abbrev);

    // Re-render the clicked row
    const isSelected = selectedRivals.has(abbrev);
    const colors = getTeamColors(abbrev);

    btn.style.backgroundColor = isSelected ? 'rgba(205, 92, 92, 0.15)' : 'transparent';

    const checkbox = btn.querySelector('.w-6.h-6');
    if (checkbox) {
      checkbox.style.borderColor = isSelected ? accentRed : 'rgba(255,255,255,0.3)';
      checkbox.style.backgroundColor = isSelected ? accentRed : 'transparent';
      checkbox.innerHTML = isSelected ? `
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      ` : '';
    }

    updateCount();
  }

  async function loadTeams() {
    try {
      const teams = await fetchTeams();
      loading?.classList.add('hidden');
      teamList?.classList.remove('hidden');
      renderTeams(teams);

      // Add click handler
      teamList?.addEventListener('click', handleTeamClick);
    } catch (error) {
      console.error('Failed to load teams:', error);
      if (loading) {
        loading.innerHTML = `
          <p style="color: var(--accent-red);">Failed to load teams</p>
          <button onclick="location.reload()" class="btn mt-4 px-4 py-2 rounded-lg" style="background-color: var(--accent-red); color: white;">
            Retry
          </button>
        `;
      }
    }
  }

  // Clear all handler
  clearBtn?.addEventListener('click', async () => {
    selectedRivals = clearAllRivals();
    const teams = await fetchTeams();
    renderTeams(teams);
  });

  // Initial load
  loadTeams();
</script>
