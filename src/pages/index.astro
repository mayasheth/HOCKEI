---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Rival Watch - Feed" activePage="feed">
  <div class="max-w-2xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-end mb-4">
      <button
        id="refresh-btn"
        class="btn px-3 py-1.5 text-sm font-medium rounded-lg"
        style="background-color: var(--accent-red); color: white;"
      >
        Refresh
      </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="flex flex-col items-center justify-center py-20">
      <div class="spinner w-8 h-8 border-2 border-white/20 border-t-white/80 rounded-full mb-4"></div>
      <p style="color: var(--text-secondary);">Loading your rivals' misfortune...</p>
    </div>

    <!-- Empty State -->
    <div id="empty" class="hidden text-center py-20">
      <p class="text-xl mb-2" style="color: var(--text-secondary);">No rivals selected</p>
      <p class="mb-6" style="color: var(--text-muted);">Pick some teams you love to hate</p>
      <a
        href="/rivals"
        class="btn inline-block px-6 py-2 rounded-lg font-medium"
        style="background-color: var(--accent-red); color: white;"
      >
        Select rivals
      </a>
    </div>

    <!-- No Events State -->
    <div id="no-events" class="hidden text-center py-20">
      <p class="text-xl mb-2" style="color: var(--text-secondary);">Nothing to celebrate... yet</p>
      <p style="color: var(--text-muted);">Your rivals haven't suffered recently</p>
    </div>

    <!-- Events Feed -->
    <div id="feed" class="hidden space-y-4"></div>


  </div>
</Layout>

<script>
  import { fetchNegativeEvents } from '../lib/nhl.js';
  import { getSelectedRivals } from '../lib/store.js';
  import { createGoalCard, createLossCard, createDayHeader } from '../lib/cards.js';

  const loading = document.getElementById('loading');
  const empty = document.getElementById('empty');
  const noEvents = document.getElementById('no-events');
  const feed = document.getElementById('feed');
  const refreshBtn = document.getElementById('refresh-btn');

  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const eventDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

    const diffDays = Math.floor((today.getTime() - eventDate.getTime()) / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'TODAY';
    if (diffDays === 1) return 'YESTERDAY';

    return date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }).toUpperCase();
  }

  function groupEventsByDay(events) {
    const groups = new Map();
    for (const event of events) {
      const dateKey = formatDate(event.timestamp);
      if (!groups.has(dateKey)) {
        groups.set(dateKey, []);
      }
      groups.get(dateKey).push(event);
    }
    return groups;
  }

  async function loadFeed() {
    const rivals = getSelectedRivals();

    // Show appropriate state
    loading.classList.remove('hidden');
    empty.classList.add('hidden');
    noEvents.classList.add('hidden');
    feed.classList.add('hidden');
    // Keep mockups visible for comparison

    if (rivals.size === 0) {
      loading.classList.add('hidden');
      empty.classList.remove('hidden');
      return;
    }

    try {
      const events = await fetchNegativeEvents(rivals, 3);

      loading.classList.add('hidden');

      if (events.length === 0) {
        noEvents.classList.remove('hidden');
        return;
      }

      // Group events by day
      const grouped = groupEventsByDay(events);

      // Build feed HTML
      let html = '';
      for (const [dateStr, dayEvents] of grouped) {
        html += createDayHeader(dateStr);
        for (const event of dayEvents) {
          if (event.type === 'loss') {
            html += createLossCard(event);
          } else {
            html += createGoalCard(event);
          }
        }
      }

      feed.innerHTML = html;
      feed.classList.remove('hidden');
    } catch (error) {
      console.error('Failed to load feed:', error);
      loading.classList.add('hidden');
      noEvents.classList.remove('hidden');
    }
  }

  // Initial load
  loadFeed();

  // Refresh button
  refreshBtn?.addEventListener('click', loadFeed);
</script>
